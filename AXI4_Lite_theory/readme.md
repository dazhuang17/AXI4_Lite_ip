# fpga硬件基础

## 写在前面
- 总结于 [牛客网](https://www.nowcoder.com/exam/intelligent) 的fpga硬件基础 相关知识

## 1 Verilog中的标识符
<details>
<summary>详情</summary>

Verilog HDL中的标识符可以是任意一组字母、数字、$符号和_(下划线)的组合，但标识符的第一个字符必须是字母或者下划线，标识符是区分大小写的。

</details>

## 2 Verilog中的函数
<details>
<summary>详情</summary>

在Verilog语言中，函数只能`在模块中定义`，位置任意，并在模块的任何地方引用，作用范围也`局限于此模块`。函数主要有以下几个特点：  
- 不含有任何`延迟、时序或时序控制逻辑`；
- 至少有一个输入变量；
- 只有`一个返回值`，且没有输出；
- 不含有非阻塞赋值语句；
- 函数可以`调用其他函数`，但是不能调用任务；任务可以调用函数。

</details>

## 3 无损定点化
<details>
<summary>详情</summary>

**对11.916做无损定点化，最小位宽是多少位？选择最小位宽时量化误差是多少**  

11.916，定点量化时对`整数部分和小数部分`分别量化。  
- 整数部分11，最少使用4位量化，4-bit表示范围0~15；
- 小数部分0.916，假设11.916`整体`使用11位量化，整数已使用4-bit，则小数部分还能使用7-bit量化，能够表示2的7次方共计128个刻度，每个刻度的间隔是1/128 = 0.0078125，这个值也就是`量化精度`。

小数0.916需要多少个刻度来表示呢？ 0.916/(1/128) = 0.916*256 = 117.248，四舍五入取整，
则使用`117`个刻度来表示，`误差`是0.248个刻度，`量化误差`大小是0.248*(1/128) = 0.0019375。  
`量化误差小于量化精度的一半，认为是“无损量化”`。由于量化后误差0.0019375小于精度0.0078125的一半，所以这个误差小到可以认为是无损量化。  

</details>

## 4 电路综合
<details>
<summary>详情</summary>

**所有综合工具都支持的结构**  
always，assign，begin，end，case，wire，tri，aupply0，supply1，reg，integer，default，for，function，and，nand，or，nor，xor，xnor，buf，not，bufif0，bufif1，notif0，notif1，if，inout，input，instantitation，module，negedge，posedge，operators，output，parameter

**所有综合工具都不支持的结构**  
time，defparam，$finish，fork，join，initial，delays，UDP，wait

**有些工具支持有些工具不支持的结构**  
casex，casez，wand，triand，wor，trior，real，disable，forever，arrays，memories，repeat，task，while。

</details>

## 5 扭环形计数器
<details>
<summary>详情</summary>

**移位寄存器由 16 级触发器组成，用它构成的扭环形计数器具有多少种有效状态；用它构成的环形计数器具有多少种有效状态。**  

`扭环形计数器`，亦称约翰逊计数器，每次状态变化时仅有`一个触发器`发生翻转，译码不存在竞争冒险，在n（n≥3）位计数器中，使用2n个状态，有2^n-2n个状态未使用。  
下图为模10的扭环形计数器的电路图和状态图。  

![](./images/0.jpg)  

`环形计数器`，正常工作时所有触发器中只有一个是1（或0）状态，计n个数需要n个触发器，状态利用率低。  

</details>

## 6 十进制数转二进制数
<details>
<summary>详情</summary>

**十进制数20.125的二进制表达式。**  

`整数部分`，没什么好说的。  
`小数部分`，乘2取整，顺序排列。

具体做法是：用2乘十进制小数，可以得到积，将积的整数部分取出，
再用2乘余下的小数 部分，又得到一个积，再将积的整数部分取出，如此进行，直到积中的小数部分为零，或者达到所要求的精度为止。   

</details>

## 7 AMBA总线
<details>
<summary>详情</summary>

AMBA是由ARM公司研发推出的一种高级微控制器总线架构(Advanced Microcontroller Bus Architecture)。
其中AMBA包含了四种不同的总线标准，分别是：`AHB、ASB、APB、AXI`。   

补充：
- `SPI(Serial Perripheral Interface)`, 串行外围设备接口, 不属于AMBA总线。是 Motorola 公司推出的一种`同步串行接口技术`，是一种`高速`的，`全双工`，`同步`的通信总线。SPI 主要应用在 EEPROM, Flash, 实时时钟(RTC)等场景。 它在芯片中只占用四根管脚 (Pin) 用来控制以及数据传输, 节约了芯片的 pin 数目, 同时为 PCB 在布局上节省了空间。
- `PCIe(Peripheral Component Interconnect Express)`是继ISA和PCI总线之后的第三代I/O总线。一般翻译为周边设备高速连接标准。PCIe协议是一种端对端的互连协议，提供了高速传输带宽的解决方案。
- `I2C`总线是由Philips公司开发的一种`简单`、`双向`二线制同步串行总线。它只需要两根线即可在连接于总线上的器件之间传送信息。

</details>

## 8 一些电路
<details>
<summary>详情</summary>

**数据选择器**  
![](./images/1.jpg)  

**数值比较器**  
![](./images/2.jpg)  

**半加器**  
![](./images/3.jpg)  

**全加器**  
![](./images/4.jpg)  

</details>

## 9 程序控制类指令
<details>
<summary>详情</summary>

程序控制类指令包括`跳转指令`、`循环指令`、`子程序指令`以及`中断指令`，控制程序的执行顺序。  

</details>

## 10 AXI总线
<details>
<summary>详情</summary>

AXI总线和AHB总线 均 支持`突发传输`，均 支持`多主/从结构`。  
AXI总线接口数量 `多于` AHB总线；AXI总线共5个通道，支持读/写并行操作。  

</details>

## 11 RAM
<details>
<summary>详情</summary>

RAM可分为`静态存储器`（Static Random Access Memory,SRAM）和 `动态存储器`（Dynamic Random Access Memory）。  
- SRAM 中的存储单元相当于一个锁存器，只有0，1两个稳态。
- DRAM 则是利用电容存储电荷来保存0和1两种状态，因此需要定时对其进行刷新，否则随着时间的推移，电容其中存储的电荷将逐渐消失。
- SRAM：读写速度快，生产成本高，多用于容量较小的高速缓冲存储器。
- DRAM：读写速度较慢，集成度高，生产成本低，多用于容量较大的主存储器。  

</details>

## 12 同步数字电路的最高频率
<details>
<summary>详情</summary>

对于同步数字电路的最高频率，主要取决于关键路径是否能够收敛。  
- 逻辑块间互联布线长度。
- 触发器之间的最长组合逻辑。
- 触发器的建立保持时间。

注意：时钟的低电平持续时间主要影响到时钟信号的有效性。需要做clock pulse width检测，保证该时钟沿能正确地被寄存器采集。如果不满足，则逻辑功能有问题，和最高工作频率无关。  

</details>

## 13 跨时钟域的数据传输
<details>
<summary>详情</summary>

**锁存+握手信号**  
- 两个时域之间通过请求和应答信号线进行握手，时域A发送请求发送数据信号req，同时是准备好数据；
- 时域B接收到时域A发送的请求信号后，回应一个应答信号ack，同时将数据接收进行寄存；
- 时域A接收到应答信号后重新发送请求信号req，进行第二个数据传输，依次直到完成时域A数据发送完成。  
但是要注意程序设计，不正确的程序设计将会发生`数据漏取`（快时域到慢时域）或者`插入数据`（慢时域到快时域）  

**DMUX（数据分配器）电路**  
DMUX同步器：对于多bit的data信号，还可以使用使能技术，也就是通过一个使能信号来判断data信号是否已经稳定，
当使能信号有效的时候说明data处于稳定状态，在这种情况下终点寄存器才对信号进行采样，可以保证没有setup/hold违例。
而使能信号一般使用double FF的方法来进行同步。  

**异步FIFO**  
无论是快到慢，还是慢到快，FIFO均可满足。FIFO的设计需要注意FIFO空满信号产生问题、格雷码的应用问题、深度选择问题等。  

**格雷码**（不完全正确传输）（尽量不要使用）  
格雷码的应用问题，也许会想到能不能先把数据变成格雷码，然后再通过双D触发器同步过去呢？
- 如果计数器计数0到7，那么是可以的，因为相邻两个数都是只有一位不同；
- 如果计数0到6，那么从计数6（格雷码为101）到计数0（格雷码为000），格雷码有两位不同，这个时候就不能再用双触发器的方法了。  

</details>

## 14 条件运算符
<details>
<summary>详情</summary>

`cond_expr?expr1:expr2;`  
- 如果cond_expr为真（即为1），选择expr1;
- 如果cond_expr为假（即为0），选择expr2;
- 如果cond_expr为x或z，结果将按以下 逻辑 `expr1` 和 `expr2` 按位操作的值：0与0得0，1与1得1，其余情况为x.

</details>

## 15 有符号数 signed
<details>
<summary>详情</summary>

**有符号数通常以2的补码形式来表示**  

示例：  
```
在下列Verilog代码中，a=11, b=10，则z的运算结果为：

    input [3:0] a;
    input [3:0] b;
    output signed [7:0] z;
     
    wire signed [3:0] c;
    assign c = a[3:0] * b[3:0];
    assign z = c;
```

**在运算中，只要是有无符号数参与，就按无符号数运算**  

a[3:0] * b[3:0] 得到 0110_1110 ， 截取 4 位，c 为 1110。  
z 是有符号数，且 c 的最高位符号位为 1，所以进行符号位的扩展，得到 1111_1110，该数表示 -2。  
将 z 去掉符号位，得到 111_1110 ，取补码（反码，+1），则为 0000_0010。  

</details>

## 16 CMOS电路功耗
<details>
<summary>详情</summary>

**功耗是门电路重要参数之一。功耗有静态和动态之分。**  

静态功耗是指电路输出没有状态转换时的功耗。
静态时，CMOS电路的电流非常小，使得`静态功耗非常低`。
CMOS反相器在静态时，P、N管只有一个导通。
由于没有 Vdd 到 GND 的直流通路，所以CMOS的静态功耗应该等于零。
但实际上，由于`扩散区和衬底的PN结上存在反向漏电流`，所以会产生静态功耗。  

CMOS电路在输出发生状态转换时的功耗称为动态功耗。
它主要由两部分组成。一部分是电路输出状态转换瞬间MOS管的导通功耗。  
当输出电压由高到低或由低到高变化过程中，在短时间内，NMOS管和PMOS管均导通，从而导致有较大的电流从电源经导通的NMOS管和PMOS管流入地。  
动态功耗的另一部分是因为`CMOS管的负载通常是电容性的`，当输出由高电平到低电平，或者由低电平到高电平转换时，会对电容进行充、放电，这一过程将增加电路的损耗。

</details>

## 17 加法器
<details>
<summary>详情</summary>

**行波进位加法器（RCA）**  

![](./images/5.jpg)  

**超前进位加法器（LCA）**  

![](./images/6.jpg)  

- RCA的缺点在于关键路径长，限制了速度，性能不高；
- LCA关键路径短，速度快，进位链计算依赖少，但对于位宽较大的加法器，PG和进位生成逻辑大，存在较大扇入扇出，变化信号多，会有较多的glitch，且面积与复杂度比同等的RCA大。

</details>

## 18 静态时序分析的时序路径
<details>
<summary>详情</summary>

- 模块外部输入 -> 第一级寄存器数据输入。
- 寄存器的时钟引脚 -> 寄存器数据输入。
- 寄存器的时钟引脚 -> 模块外部输出。
- 模块外部输入 -> 模块外部输出。  

</details>

## 19 主存和Cache的映射关系
<details>
<summary>详情</summary>

- 全相联映射
- 直接相联映射
- 组相联映射 

</details>

## 20 竞争冒险
<details>
<summary>详情</summary>

[参考网址](https://www.runoob.com/w3cnote/verilog-competition-hazard.html)  
**竞争  冒险**  
信号经过逻辑门电路都需要一定的时间。
由于不同路径上门的级数不同，信号经过不同路径传输的时间不同。或者门的级数相同，而各个门延迟时间的差异，也会造成传输时间的不同。
因此，电路在信号电平变化瞬间，可能与稳态下的逻辑功能不一致，产生错误输出。  

- `竞争` ：在组合逻辑电路中，不同路径的输入信号变化传输到同一点门级电路时，在时间上有先有后，这种先后所形成的时间差称为竞争。
- `冒险` ：由于竞争的存在，输出信号需要经过一段时间才能达到期望状态，过渡时间内可能产生瞬间的错误输出，例如尖峰脉冲。这种现象被称为冒险。
- 竞争不一定有冒险，但冒险一定会有竞争

一般，消除竞争和冒险的方法有
- 增加滤波电容，滤除窄脉冲
- 修改逻辑，增加冗余项
- 使用时钟同步电路，利用触发器进行打拍延迟
- 采用格雷码计数器  

</details>

## 21 0、1、x、z
<details>
<summary>详情</summary>

在Verilog中，存在0、1、X、Z四种逻辑，其中X不定态，Z高阻态（X、Z不区分大小写）。  
- 输入只要有X不定态，输出就是X不定态。
- 输入是高阻态Z和0，输出是0；
- 输入是高阻态Z和1，输出是X不定态。

</details>

## 22 APB总线
<details>
<summary>详情</summary>

- 高级外围总线。
- 单主设备多从设备，其主设备就是APB桥，不具有仲裁机制。
- 读写地址共用读写数据通道，不支持读写并行操作。

</details>
